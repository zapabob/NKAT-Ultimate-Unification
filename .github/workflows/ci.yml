name: ğŸš€ NKAT GPUåŠ é€Ÿç†è«–ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:       # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  schedule:
    - cron: '0 6 * * 1'     # æ¯é€±æœˆæ›œæ—¥ 6:00 UTC ã«è‡ªå‹•å®Ÿè¡Œ

env:
  PYTHON_VERSION: "3.11"
  CUDA_VERSION: "12.1"
  TORCH_VERSION: "2.2.0"

jobs:
  # CPUç‰ˆãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ï¼ˆåŸºæœ¬å‹•ä½œç¢ºèªï¼‰
  cpu-benchmark:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆCPUç‰ˆï¼‰
        run: |
          python -m pip install --upgrade pip
          pip install torch==${{ env.TORCH_VERSION }}+cpu -f https://download.pytorch.org/whl/torch_stable.html
          pip install -r requirements.txt
          pip install psutil tqdm pytest
          
      - name: ğŸ§ª åŸºæœ¬å‹•ä½œãƒ†ã‚¹ãƒˆ
        run: |
          cd src
          python -c "
          import numpy as np
          import scipy.sparse
          import matplotlib.pyplot as plt
          print('âœ… åŸºæœ¬ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå‹•ä½œç¢ºèªå®Œäº†')
          "

      - name: ğŸš€ CPUç‰ˆè»½é‡ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ï¼ˆ8Â³æ ¼å­ï¼‰
        run: |
          cd src
          python riemann_gpu_accelerated_stable.py \
                 --lattice 8 --precision complex128 \
                 --sparse csr --eig 64 --no-gpu \
                 --save ci_cpu_lattice8.json
        
      - name: ğŸ“Š çµæœæ¤œè¨¼
        run: |
          cd src
          python -c "
          import json
          with open('ci_cpu_lattice8.json', 'r') as f:
              data = json.load(f)
          metrics = data.get('performance_metrics', {})
          precision = float(metrics.get('precision_achieved', '0').replace('%', ''))
          success_rate = metrics.get('success_rate', 0)
          print(f'CPUç‰ˆç²¾åº¦: {precision:.2f}%')
          print(f'æˆåŠŸç‡: {success_rate:.2%}')
          assert precision > 10.0, f'ç²¾åº¦ãŒä½ã™ãã¾ã™: {precision}%'
          assert success_rate > 0.2, f'æˆåŠŸç‡ãŒä½ã™ãã¾ã™: {success_rate}'
          print('âœ… CPUç‰ˆãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯æ¤œè¨¼å®Œäº†')
          "

      - name: ğŸ“¤ CPUç‰ˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: cpu-benchmark-results
          path: |
            src/ci_cpu_lattice8.json
            src/stabilized_gpu_nkat_benchmark_*.json
          retention-days: 30

  # GPUç‰ˆãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ï¼ˆCUDAå¯¾å¿œï¼‰
  gpu-benchmark:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    container:
      image: nvidia/cuda:12.1.1-devel-ubuntu22.04
      options: --gpus all
    
    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          apt-get update
          apt-get install -y python3 python3-pip python3-dev git
          ln -sf /usr/bin/python3 /usr/bin/python

      - name: ğŸ® CUDAç’°å¢ƒç¢ºèª
        run: |
          nvidia-smi || echo "âš ï¸ GPUæœªæ¤œå‡ºã€CPUç‰ˆã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯"
          nvcc --version || echo "âš ï¸ NVCCæœªæ¤œå‡º"

      - name: ğŸ“¦ GPUå¯¾å¿œä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install torch==${{ env.TORCH_VERSION }}+cu121 -f https://download.pytorch.org/whl/torch_stable.html
          pip install cupy-cuda12x  # GPU sparse backend
          pip install -r requirements.txt
          pip install psutil tqdm pytest
          
      - name: ğŸ§ª GPUå‹•ä½œç¢ºèª
        run: |
          python -c "
          try:
              import cupy as cp
              print('âœ… CuPy GPUåŠ é€Ÿåˆ©ç”¨å¯èƒ½')
              print(f'GPU: {cp.cuda.get_device_name()}')
              print(f'VRAM: {cp.cuda.Device().mem_info[1] / 1e9:.1f} GB')
          except ImportError:
              print('âš ï¸ CuPyæœªå¯¾å¿œã€CPUç‰ˆã§å®Ÿè¡Œ')
          except Exception as e:
              print(f'âš ï¸ GPUåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: {e}')
          "

      - name: ğŸš€ GPUç‰ˆè»½é‡ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ï¼ˆ8Â³æ ¼å­ï¼‰
        run: |
          cd src
          python riemann_gpu_accelerated_stable.py \
                 --lattice 8 --precision complex128 \
                 --sparse csr --eig 64 \
                 --save ci_gpu_lattice8.json

      - name: ğŸš€ GPUç‰ˆä¸­è¦æ¨¡ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ï¼ˆ10Â³æ ¼å­ï¼‰
        run: |
          cd src
          python riemann_gpu_accelerated_stable.py \
                 --lattice 10 --precision complex128 \
                 --sparse csr --eig 128 \
                 --save ci_gpu_lattice10.json

      - name: ğŸ“Š GPUç‰ˆçµæœæ¤œè¨¼
        run: |
          cd src
          python -c "
          import json
          import numpy as np
          
          # 8Â³æ ¼å­çµæœ
          with open('ci_gpu_lattice8.json', 'r') as f:
              data8 = json.load(f)
          metrics8 = data8.get('performance_metrics', {})
          precision8 = float(metrics8.get('precision_achieved', '0').replace('%', ''))
          
          # 10Â³æ ¼å­çµæœ
          with open('ci_gpu_lattice10.json', 'r') as f:
              data10 = json.load(f)
          metrics10 = data10.get('performance_metrics', {})
          precision10 = float(metrics10.get('precision_achieved', '0').replace('%', ''))
          
          print(f'GPUç‰ˆ 8Â³æ ¼å­ç²¾åº¦: {precision8:.2f}%')
          print(f'GPUç‰ˆ 10Â³æ ¼å­ç²¾åº¦: {precision10:.2f}%')
          
          # ç²¾åº¦å‘ä¸Šã®ç¢ºèª
          assert precision8 > 20.0, f'8Â³æ ¼å­ç²¾åº¦ãŒä½ã™ãã¾ã™: {precision8}%'
          assert precision10 > 30.0, f'10Â³æ ¼å­ç²¾åº¦ãŒä½ã™ãã¾ã™: {precision10}%'
          
          # è¨ˆç®—æ™‚é–“ã®ç¢ºèª
          time8 = metrics8.get('average_iteration_time', 999)
          time10 = metrics10.get('average_iteration_time', 999)
          print(f'8Â³æ ¼å­å¹³å‡æ™‚é–“: {time8:.2f}ç§’')
          print(f'10Â³æ ¼å­å¹³å‡æ™‚é–“: {time10:.2f}ç§’')
          
          assert time8 < 30.0, f'8Â³æ ¼å­è¨ˆç®—æ™‚é–“ãŒé•·ã™ãã¾ã™: {time8}ç§’'
          assert time10 < 60.0, f'10Â³æ ¼å­è¨ˆç®—æ™‚é–“ãŒé•·ã™ãã¾ã™: {time10}ç§’'
          
          print('âœ… GPUç‰ˆãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯æ¤œè¨¼å®Œäº†')
          "

      - name: ğŸ“¤ GPUç‰ˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: gpu-benchmark-results
          path: |
            src/ci_gpu_lattice8.json
            src/ci_gpu_lattice10.json
            src/stabilized_gpu_nkat_benchmark_*.json
            src/gpu_nkat_benchmark_analysis_*.png
          retention-days: 30

  # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒåˆ†æ
  performance-analysis:
    needs: [cpu-benchmark, gpu-benchmark]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ åˆ†æç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install numpy matplotlib pandas seaborn

      - name: ğŸ“¥ CPUç‰ˆçµæœãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: cpu-benchmark-results
          path: results/cpu/

      - name: ğŸ“¥ GPUç‰ˆçµæœãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: gpu-benchmark-results
          path: results/gpu/

      - name: ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒåˆ†æ
        run: |
          python -c "
          import json
          import matplotlib.pyplot as plt
          import numpy as np
          
          # çµæœèª­ã¿è¾¼ã¿
          with open('results/cpu/ci_cpu_lattice8.json', 'r') as f:
              cpu_data = json.load(f)
          with open('results/gpu/ci_gpu_lattice8.json', 'r') as f:
              gpu_data = json.load(f)
          
          cpu_metrics = cpu_data.get('performance_metrics', {})
          gpu_metrics = gpu_data.get('performance_metrics', {})
          
          # æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿
          cpu_precision = float(cpu_metrics.get('precision_achieved', '0').replace('%', ''))
          gpu_precision = float(gpu_metrics.get('precision_achieved', '0').replace('%', ''))
          cpu_time = cpu_metrics.get('average_iteration_time', 0)
          gpu_time = gpu_metrics.get('average_iteration_time', 0)
          
          # æ”¹å–„ç‡è¨ˆç®—
          precision_improvement = gpu_precision / (cpu_precision + 1e-6)
          speed_improvement = cpu_time / (gpu_time + 1e-6)
          
          print(f'=== NKATç†è«–ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ CI/CD ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ ===')
          print(f'CPUç‰ˆç²¾åº¦: {cpu_precision:.2f}%')
          print(f'GPUç‰ˆç²¾åº¦: {gpu_precision:.2f}%')
          print(f'ç²¾åº¦æ”¹å–„ç‡: {precision_improvement:.2f}Ã—')
          print(f'CPUç‰ˆæ™‚é–“: {cpu_time:.2f}ç§’')
          print(f'GPUç‰ˆæ™‚é–“: {gpu_time:.2f}ç§’')
          print(f'é€Ÿåº¦æ”¹å–„ç‡: {speed_improvement:.2f}Ã—')
          
          # å¯è¦–åŒ–
          plt.figure(figsize=(12, 8))
          
          # ç²¾åº¦æ¯”è¼ƒ
          plt.subplot(2, 2, 1)
          plt.bar(['CPUç‰ˆ', 'GPUç‰ˆ'], [cpu_precision, gpu_precision], 
                  color=['blue', 'red'], alpha=0.7)
          plt.ylabel('ç†è«–äºˆæ¸¬ç²¾åº¦ (%)')
          plt.title('ç²¾åº¦æ¯”è¼ƒ')
          plt.grid(True, alpha=0.3)
          
          # æ™‚é–“æ¯”è¼ƒ
          plt.subplot(2, 2, 2)
          plt.bar(['CPUç‰ˆ', 'GPUç‰ˆ'], [cpu_time, gpu_time], 
                  color=['blue', 'red'], alpha=0.7)
          plt.ylabel('å¹³å‡è¨ˆç®—æ™‚é–“ (ç§’)')
          plt.title('è¨ˆç®—æ™‚é–“æ¯”è¼ƒ')
          plt.grid(True, alpha=0.3)
          
          # æ”¹å–„ç‡
          plt.subplot(2, 2, 3)
          plt.bar(['ç²¾åº¦æ”¹å–„', 'é€Ÿåº¦æ”¹å–„'], [precision_improvement, speed_improvement], 
                  color=['green', 'orange'], alpha=0.7)
          plt.ylabel('æ”¹å–„ç‡ (Ã—)')
          plt.title('GPUç‰ˆæ”¹å–„ç‡')
          plt.grid(True, alpha=0.3)
          
          # ç·åˆã‚¹ã‚³ã‚¢
          plt.subplot(2, 2, 4)
          overall_score = np.sqrt(precision_improvement * speed_improvement)
          plt.bar(['ç·åˆã‚¹ã‚³ã‚¢'], [overall_score], color='purple', alpha=0.7)
          plt.ylabel('ç·åˆæ”¹å–„ã‚¹ã‚³ã‚¢')
          plt.title(f'ç·åˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: {overall_score:.2f}Ã—')
          plt.grid(True, alpha=0.3)
          
          plt.tight_layout()
          plt.savefig('ci_performance_comparison.png', dpi=300, bbox_inches='tight')
          print('âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒåˆ†æå®Œäº†')
          "

      - name: ğŸ“¤ åˆ†æçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: performance-analysis
          path: |
            ci_performance_comparison.png
          retention-days: 30

  # çµæœã‚µãƒãƒªãƒ¼ä½œæˆ
  create-summary:
    needs: [cpu-benchmark, gpu-benchmark, performance-analysis]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“Š CI/CDå®Ÿè¡Œã‚µãƒãƒªãƒ¼ä½œæˆ
        run: |
          cat > ci_summary.md << 'EOF'
          # ğŸš€ NKAT GPUåŠ é€Ÿç†è«–ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ CI/CD å®Ÿè¡Œçµæœ
          
          ## å®Ÿè¡Œæ—¥æ™‚
          **${{ github.run_id }}** - ${{ github.event.head_commit.timestamp }}
          
          ## ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±
          - **ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.ref_name }}
          - **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}
          - **ä½œæˆè€…**: ${{ github.actor }}
          
          ## å®Ÿè¡Œçµæœ
          - âœ… CPUç‰ˆãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯: å®Œäº†
          - âœ… GPUç‰ˆãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯: å®Œäº†  
          - âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ: å®Œäº†
          
          ## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
          1. Artifacts ã‹ã‚‰è©³ç´°çµæœã‚’ç¢ºèª
          2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒç”»åƒã‚’ç¢ºèª
          3. å¿…è¦ã«å¿œã˜ã¦æ ¼å­ã‚µã‚¤ã‚ºã‚’èª¿æ•´
          
          ## ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«
          - `ci_cpu_lattice8.json` - CPUç‰ˆ8Â³æ ¼å­çµæœ
          - `ci_gpu_lattice8.json` - GPUç‰ˆ8Â³æ ¼å­çµæœ
          - `ci_gpu_lattice10.json` - GPUç‰ˆ10Â³æ ¼å­çµæœ
          - `ci_performance_comparison.png` - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒå›³
          
          ---
          **NKAT Research Team** - è‡ªå‹•ç”Ÿæˆãƒ¬ãƒãƒ¼ãƒˆ
          EOF

      - name: ğŸ“¤ ã‚µãƒãƒªãƒ¼ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: ci-summary
          path: ci_summary.md
          retention-days: 90
